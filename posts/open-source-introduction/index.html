<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Open source: CI/CD and test infrastructure for Android #  Avito.ru is the second biggest classified in the world. We have moved our Android infrastructure into open source: Gradle plugins, emulators, and test libraries. Our code will be useful in automating CI/CD and will also facilitate the coding and support of autotests.
In this review, we will explain why we decided to move into open source, present the central libraries of the project, and suggest whom to contact with any questions."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Open source for CI/CD and test infrastructure for Android"><meta property="og:description" content="Open source: CI/CD and test infrastructure for Android #  Avito.ru is the second biggest classified in the world. We have moved our Android infrastructure into open source: Gradle plugins, emulators, and test libraries. Our code will be useful in automating CI/CD and will also facilitate the coding and support of autotests.
In this review, we will explain why we decided to move into open source, present the central libraries of the project, and suggest whom to contact with any questions."><meta property="og:type" content="article"><meta property="og:url" content="https://avito-tech.github.io/avito-android/posts/open-source-introduction/"><meta property="article:published_time" content="2019-12-26T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-26T00:00:00+00:00"><title>Open source for CI/CD and test infrastructure for Android | Avito Android</title><link rel=manifest href=/avito-android/manifest.json><link rel=icon href=/avito-android/favicon.png type=image/x-icon><link rel=alternate hreflang=ru href=https://avito-tech.github.io/avito-android/ru/posts/open-source-introduction/ title="Open source для CI/CD и тестовой инфраструктуры Авито для Android"><link rel=stylesheet href=/avito-android/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY="><script defer src=/avito-android/en.search.min.20e16256335d934d0842f7d7f78ee597f1f12cb101008d4cb6d92f042bb43baf.js integrity="sha256-IOFiVjNdk00IQvfX947ll/HxLLEBAI1MttkvBCu0O68="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-157613383-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/avito-android><span>Avito Android</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://avito-tech.github.io/avito-android/>Introduction</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/tech_radar/techradar/>Tech radar</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/knownissues/>Known Issues</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/contacts/>Contacts</a></li><li>Projects<ul><li><a href=https://avito-tech.github.io/avito-android/docs/projects/buildchecks/>Build checks</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/projects/buildproperties/>Build properties</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/projects/buildtrace/>Build trace</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/projects/cisteps/>CI Steps</a></li></ul></li><li>Contributing<ul><li><a href=https://avito-tech.github.io/avito-android/docs/contributing/howtostart/>How to start</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/contributing/docs/>Documentation</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/contributing/codereview/>Code Review</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/contributing/codestyle/>Code Style</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/contributing/featuretoggles/>Feature Toggles</a></li></ul></li><li>IDE<ul><li><a href=https://avito-tech.github.io/avito-android/docs/ide/configurations/>Конфигурации</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ide/templates/>Шаблоны</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ide/speedup/>Speedup</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ide/benchmarking/>Бенчмарки</a></li></ul></li><li>Builds<ul><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/buildtypes/>Типы сборки</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/dependencies/>Dependencies</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/minimization/>Минимизация</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/benchmarks/>Бенчмарки</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/profiling/>Профилирование</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/buildmetrics/>Метрики</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/mirakle/>Mirakle</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/assemble/troubleshooting/>Troubleshooting</a></li></ul></li><li>Architecture<ul><li><a href=https://avito-tech.github.io/avito-android/docs/architecture/dagger/>Dagger</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/architecture/modules/>Modules</a></li></ul></li><li><a href=https://avito-tech.github.io/avito-android/docs/analytics/analytics/>Аналитика</a><ul><li><a href=https://avito-tech.github.io/avito-android/docs/analytics/statsd/>Statsd</a></li></ul></li><li>Testing<ul><li><a href=https://avito-tech.github.io/avito-android/docs/test/run/>Запуск тестов</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/runner/>Test Runner</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/manual/>Ручное</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/testcaseincode/>Test case in code</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/unittesting/>Юнит тесты</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/screenshottesting/>Скриншотные тесты</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/testminimized/>Test minimized</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/reportviewer/>Report Viewer</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/troubleshootingui/>Troubleshooting</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/workmanager/>Work Manager Testing</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/flakyannotation/>Flaky annotation</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/flakytests/>Нестабильные тесты</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/toast/>Toast</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/snackbar/>Snackbar</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test/screenchecks/>Screen checks</a></li></ul></li><li><a href=https://avito-tech.github.io/avito-android/docs/test_framework/testframework/>Test framework</a><ul><li><a href=https://avito-tech.github.io/avito-android/docs/test_framework/mocking/>Mocking</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/test_framework/internals/>Internals</a></li></ul></li><li><a href=http://links.k.avito.ru/ff>Design System</a></li><li>Performance<ul><li><a href=https://avito-tech.github.io/avito-android/docs/performance/analytics/>Аналитика</a></li></ul></li><li>Checks<ul><li><a href=https://avito-tech.github.io/avito-android/docs/checks/androidlint/>Android lint</a></li></ul></li><li>CI<ul><li><a href=https://avito-tech.github.io/avito-android/docs/ci/civalues/>Требования</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/projects/cisteps/>CI Gradle Plugin</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ci/customgradleplugins/>Custom Gradle Plugins</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ci/impactanalysis/>Impact analysis</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/ci/containers/>Containers</a></li></ul></li><li>CD<ul><li><a href=https://avito-tech.github.io/avito-android/docs/cd/release/>Релиз</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/cd/artifacts/>Артефакты сборки</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/cd/qapps/>QApps</a></li></ul></li><li><a href=https://avito-tech.github.io/avito-android/docs/release/>Infra Release</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/infrastructure/>Infrastructure (Github project)</a></li><li><a href=https://avito-tech.github.io/avito-android/docs/externallibrarychangeprocess/>Внешние библиотеки</a></li></ul><ul><li><a href=/avito-android/posts/>Blog</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/avito-android/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Open source for CI/CD and test infrastructure for Android</strong>
<label for=toc-control><img src=/avito-android/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#who-we-are-and-what-we-do>Who we are and what we do</a></li><li><a href=#why-open-source>Why open source</a></li><li><a href=#get-feedback-and-make-the-code-easier-to-reuse>Get feedback and make the code easier to reuse</a><ul><li><a href=#influence-the-industry-standards>Influence the industry standards</a></li><li><a href=#learn-by-teaching>Learn by teaching</a></li><li><a href=#influencing-third-party-libraries-and-fixing-their-problems-faster>Influencing third-party libraries and fixing their problems faster</a></li><li><a href=#pr-and-personal-motivation>PR and personal motivation</a></li></ul></li><li><a href=#whats-in-the-open-source>What’s in the open source</a><ul><li><a href=#test-runner>Test runner</a></li><li><a href=#impact-analysis>Impact analysis</a></li></ul></li><li><a href=#how-our-libraries-can-be-useful>How our libraries can be useful</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/avito-android/posts/open-source-introduction/>Open source for CI/CD and test infrastructure for Android</a></h1><h5>December 26, 2019</h5><div><a href=/avito-android/tags/open-source/>open-source</a></div><p><h1 id=open-source-cicd-and-test-infrastructure-for-android>Open source: CI/CD and test infrastructure for Android
<a class=anchor href=#open-source-cicd-and-test-infrastructure-for-android>#</a></h1><p>Avito.ru is the second biggest classified in the world.
We have moved our Android infrastructure into open source: Gradle plugins, emulators, and test libraries.
<a href=https://github.com/avito-tech/avito-android>Our code</a> will be useful in automating CI/CD and will also facilitate the coding and support of autotests.</p><p>In this review, we will explain why we decided to move into open source, present the central libraries of the project, and suggest whom to contact with any questions.
We will analyze in detail the individual libraries, Gradle plugins, and our development approaches in future posts.</p><p><img src=https://user-images.githubusercontent.com/1104540/80410956-0cf44200-88d4-11ea-879d-cd9b6acd29af.png alt=ijhasr2dv95azaem9mgilu7e1kw></p><h2 id=who-we-are-and-what-we-do>Who we are and what we do
<a class=anchor href=#who-we-are-and-what-we-do>#</a></h2><p>We are developing solutions for Android as part of the Speed platform team. There are four of us:</p><div class="book-columns flex flex-wrap"><div class="flex-even markdown-inner"><p>Sergey Boishtyan<br>Senior engineer<br><a href=https://twitter.com/sboishtyan>sboishtyan</a></p><p><img src=https://user-images.githubusercontent.com/1104540/80411459-e8e53080-88d4-11ea-9751-1ed675da9f25.jpg alt></p></div><div class="flex-even markdown-inner"><p>Dima Voronin<br>Lead engineer<br><a href=https://twitter.com/DmitriVoronin>DmitriVoronin</a></p><p><img src=https://user-images.githubusercontent.com/1104540/80411540-074b2c00-88d5-11ea-8087-ddbab5d85dd3.jpg alt></p></div><div class="flex-even markdown-inner"><p>Eugene Krivobokov<br>Senior engineer<br><a href=https://twitter.com/eugene_kr>eugene_kr</a></p><p><img src=https://user-images.githubusercontent.com/1104540/80413105-9a856100-88d7-11ea-9e07-b5a5e48882cf.png alt></p></div><div class="flex-even markdown-inner"><p>Daniil Popov<br>Senior engineer<br><a href=https://twitter.com/int02h>Int02h</a></p><p><img src=https://user-images.githubusercontent.com/1104540/80411864-8d677280-88d5-11ea-8a91-4f40d3eec71d.jpg alt></p></div></div><p>We are in charge of delivering changes in all Avito’s Android apps to users as fast as possible. Our area of responsibility covers:</p><ul><li>Local project activities: making sure that everything is quickly built and the IDE runs fast.</li><li>CI pipeline: tests and all possible checks.</li><li>CD: tools for release engineers.</li></ul><h2 id=why-open-source>Why open source
<a class=anchor href=#why-open-source>#</a></h2><p>We wanted not only to mirror the code in the open source repository on GitHub but also to learn something new and make a contribution to the software engineering community.
There were five key reasons to move the project into open source:</p><ul><li>Get feedback.</li><li>Influence industry standards.</li><li>Learn something new.</li><li>Influence third-party libraries.</li><li>Promote our personal brands.</li></ul><p>Let&rsquo;s discuss these one by one.</p><h2 id=get-feedback-and-make-the-code-easier-to-reuse>Get feedback and make the code easier to reuse
<a class=anchor href=#get-feedback-and-make-the-code-easier-to-reuse>#</a></h2><p>We do the tooling for Avito’s engineers, and our users need all solutions to simply work.
We lack the outsider perspective of developers who work on similar problems.
We need them to point out issues in the internal implementation and the convenience of connecting to our project.</p><p>We have already seen how moving the code to GitHub highlighted the problems of reuse.
When you understand that other companies can use your project, you start looking at the architecture differently.
Reusing code is not the ultimate target. But this external criterion says a lot about the quality of the architecture and its flexibility.</p><h3 id=influence-the-industry-standards>Influence the industry standards
<a class=anchor href=#influence-the-industry-standards>#</a></h3><p>We have been developing infrastructure for mobile apps since 2017 and regularly make talks at local developer conferences and meetups.</p><p>We always wanted to share the code in addition to our words and allow others to reuse it.
Indeed, many Android developers face similar challenges:</p><ul><li>How to write effective autotests.</li><li>How to run these in pull requests.</li><li>How to maintain infrastructure cost-effectively.</li></ul><p>There are no generally accepted, universal solutions for these tasks — each company solves them in its way.
We share our best practices so that developers of new projects do not have to collect bit by bit information on testing mobile apps and building CI/CD.
We want to offer ready-made solutions for routine problems instead of having to invent the wheel.
And even if nobody uses the project code in its original form, developers will be able to see our approaches and improve their libraries.</p><h3 id=learn-by-teaching>Learn by teaching
<a class=anchor href=#learn-by-teaching>#</a></h3><p>Just moving the code into open source is not enough.
Practices, approaches, methods of troubleshooting, and making decisions — this is what is essential.
Sharing these, we verify whether our ideas and ready-made solutions work outside of Avito.</p><h3 id=influencing-third-party-libraries-and-fixing-their-problems-faster>Influencing third-party libraries and fixing their problems faster
<a class=anchor href=#influencing-third-party-libraries-and-fixing-their-problems-faster>#</a></h3><p>Imagine you are facing a problem in Android or a library and cannot find a workaround.
You need help from the community or the code’s authors.
You asked a question on Stack Overflow, filed a bug report in Google IssueTracker, described everything in detail, but the problem won’t reproduce.
You are asked to share a test case. All this takes extra time.</p><p>Open source helps you create a reproducible example faster.
We have a test app, which uses part of the infrastructure. Its main function is dogfooding, i.e. making sure as early
as possible using a simple and isolated case that everything works.
But this same app makes it easier to demonstrate bugs. When we show a reproducible example in a third-party library,
it becomes easier for its developer to understand what is going on. This increases the chances that the developers will fix the issue.</p><p>The popularity of an open source project also increases the likelihood that you will be paid attention to.
When an issue in a library has many stars and users, this increases the pressure, and the issue becomes more difficult to ignore.
Achieving this without open source is more challenging — the app has to be super popular, or one should make oneself known.</p><h3 id=pr-and-personal-motivation>PR and personal motivation
<a class=anchor href=#pr-and-personal-motivation>#</a></h3><p>Last but not least, is personal benefit. Everybody benefits when their daily work gains publicity.
Avito grabs public attention by offering a useful product, and we promote our personal brands as engineers and develop additional motivation for working.
We no longer need to use our free time to work on our own projects or commits in third-party open source libraries.</p><h2 id=whats-in-the-open-source>What’s in the open source
<a class=anchor href=#whats-in-the-open-source>#</a></h2><p>We have made available <a href=https://github.com/avito-tech/avito-android>in the GitHub repository</a> almost all of our Android and CI/CD testing infrastructure.
To make it easier for other developers to navigate the project, we grouped all its modules by function:</p><ul><li>Gradle plugins.</li><li>Libraries for Android testing modules.</li><li>Emulators.</li></ul><p>Let’s discuss some of the most important libraries.</p><h3 id=test-runner>Test runner
<a class=anchor href=#test-runner>#</a></h3><p>This is a Gradle plugin to run instrumentation tests.
The closest analog is <a href=https://github.com/Malinskiy/marathon>Marathon</a>, but our plugin runs only under Android.</p><p><a href=https://avito-tech.github.io/avito-android/docs/test/runner/>Test runner:</a></p><ul><li>Specifies which tests to run. Filtering by annotations, by packages, by the results of the last run is supported.</li><li>Specifies which emulators to run tests on. Backs these up to Kubernetes or connects to local emulators.</li><li>Sets test restart conditions.</li><li>Sends a final report with the test run results.</li></ul><p>The results are stored in custom TMS (test management system), which is not open source.
We are working on the possibility of connecting to a different implementation.</p><p><img src=https://habrastorage.org/webt/1s/pt/62/1spt626ixunfqut3ya9ubxti_us.png alt></p><h3 id=impact-analysis>Impact analysis
<a class=anchor href=#impact-analysis>#</a></h3><p>We have about 1,600 instrumentation tests and 10K unit tests. We would like to run all the tests for any code change,
but this is not possible — such a test run would take too much time.</p><p>A simple solution is to manually subdivide the tests into subsets, for example, smoke tests, fast, slow tests, and run only one set at a time.
But with this approach, there is always a risk of missing an error, because it is not clear which set of tests is optimal.
An ideal solution would be to understand which minimum test set can verify all changes.
This is known as <a href=https://martinfowler.com/articles/rise-test-impact-analysis.html>test impact analysis</a>.</p><p>We wrote <a href=https://avito-tech.github.io/avito-android/docs/ci/impactanalysis/>a Gradle plugin</a>, which searches for changes in modules, parses tests, and determines which ones to run.</p><p><img src=https://habrastorage.org/webt/ox/s3/8i/oxs38itwej7tehznhbslvjpmsi0.png alt></p><p>For more details of the main modules and approaches, see <a href=https://avito-tech.github.io/avito-android/docs/infrastructure/#buildscript-dependencies>the project documentation</a>.
It is still incomplete, and not everything is translated. We want to make the documentation easier to understand, and need your help.
Tell us what to improve and correct in the documentation in <a href=https://t-do.ru/avito_android_opensource_en>our Telegram chat</a>.</p><h2 id=how-our-libraries-can-be-useful>How our libraries can be useful
<a class=anchor href=#how-our-libraries-can-be-useful>#</a></h2><p>Since there are many components in our project, its applications depend on your needs.
If you are working on a similar problem or just want to understand the technology better — feel free to contact us
in GitHub or our <a href=https://t-do.ru/avito_android_opensource_en>Telegram chat</a>.
We will share what we know, try to help, and show relevant examples.</p><p>You can ask anything:</p><ul><li>How do we handle unstable tests?</li><li>Why so much code? It makes no sense.</li><li>Why is all the code in Gradle plugins and not in python scripts?</li></ul><p>If you want to use a specific module, you can try it in <a href=https://github.com/avito-tech/avito-android/tree/develop/samples/test-app>the test app</a>.
Currently, it shows an example of using our test runner.</p><p>Unfortunately, we still have few examples of reuse in other projects, so integration may reveal yet unknown limitations. Let us know if this happens, and we we will see what to fix.</p><h2 id=conclusion>Conclusion
<a class=anchor href=#conclusion>#</a></h2><p>In our upcoming posts, we plan to talk about:</p><ul><li>Our test runner.</li><li>Test anatomy — what happens from the moment of clicking “Run” in the IDE up to the test completion moment.</li><li>How we deal with the instability of tests and infrastructure.</li><li>Our approaches to writing infrastructure.</li><li>How we reduced the release time from month to week.</li></ul><p>We want to discuss some more general topics, too:</p><ul><li>How to start writing tests.</li><li>Fundamentals of testing for beginners — common approaches and technologies.</li></ul><p>Comment to let us know what you would like to read about. So we will know which topic to cover first.</p></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/avito-android/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li class=active><a href=https://avito-tech.github.io/avito-android/ class="flex align-center"><img src=/avito-android/svg/translate.svg class=book-icon alt=Languages>
English</a></li><li><a href=https://avito-tech.github.io/avito-android/ru/posts/open-source-introduction/ class="flex align-center"><img src=/avito-android/svg/translate.svg class=book-icon alt=Languages>
Русский</a></li></ul></div><div><a class="flex align-center" href=https://github.com/avito-tech/avito-android/tree/develop/docs/content//posts/open-source-introduction.md target=_blank rel=noopener><img src=/avito-android/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#who-we-are-and-what-we-do>Who we are and what we do</a></li><li><a href=#why-open-source>Why open source</a></li><li><a href=#get-feedback-and-make-the-code-easier-to-reuse>Get feedback and make the code easier to reuse</a><ul><li><a href=#influence-the-industry-standards>Influence the industry standards</a></li><li><a href=#learn-by-teaching>Learn by teaching</a></li><li><a href=#influencing-third-party-libraries-and-fixing-their-problems-faster>Influencing third-party libraries and fixing their problems faster</a></li><li><a href=#pr-and-personal-motivation>PR and personal motivation</a></li></ul></li><li><a href=#whats-in-the-open-source>What’s in the open source</a><ul><li><a href=#test-runner>Test runner</a></li><li><a href=#impact-analysis>Impact analysis</a></li></ul></li><li><a href=#how-our-libraries-can-be-useful>How our libraries can be useful</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside></main></body></html>